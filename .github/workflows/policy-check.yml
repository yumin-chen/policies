name: Policy Check

on:
  pull_request:
    paths:
      - 'opa/**'
      - 'templates/**'

jobs:
  opa-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: 0.50.0
      - name: Run OPA tests
        run: opa test opa/policies/ opa/tests/

  opa-eval:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: 0.50.0
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: api/package-lock.json
      - name: Get changed templates
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files: templates/**
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Run opa eval
        run: |
          for f in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Checking $f"
            input=$(jq -n --slurpfile template "$f" \
              '{
                "action": "register_template",
                "actor": {"principal_id": "github:alice", "roles": ["template_author"]},
                "template": $template[0]
              }')
            result=$(echo "$input" | opa eval --data opa/policies --input - "data.template.authz.decision")

            # The result from opa eval is a JSON object like {"result": [{"expressions": [{"value": ...}]}]}
            # We need to extract the actual decision object.
            decision=$(echo "$result" | jq -r '.result[0].expressions[0].value')
            allow=$(echo "$decision" | jq -r '.allow')

            if [[ "$allow" != "true" ]]; then
              echo "Policy denial for $f"
              reasons=$(echo "$decision" | jq -r '.reasons')
              echo "Reasons: $reasons"
              exit 1
            fi
          done
