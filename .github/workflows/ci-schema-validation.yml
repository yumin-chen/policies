name: Schema Validation

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  validate-schemas:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip jq
          pip install jsonschema

      - name: Install Conftest (OPA)
        run: |
          wget https://github.com/open-policy-agent/conftest/releases/download/v0.46.0/conftest_0.46.0_Linux_x86_64.tar.gz
          tar xf conftest_0.46.0_Linux_x86_64.tar.gz
          sudo mv conftest /usr/local/bin/

      - name: Validate JSON syntax
        run: |
          find docs/events/schema-registry -name "*.json" -print0 | \
            xargs -0 -I {} sh -c "jq empty {}"

      - name: Validate schema structure
        run: |
          conftest test docs/events/schema-registry --policy policies

      - name: Validate example events (if present)
        run: |
          if ls docs/events/samples/*.json 1> /dev/null 2>&1; then
            for f in docs/events/samples/*.json; do
              schema="docs/events/schema-registry/$(jq -r .type $f)_v1.json"
              echo "Validating sample $f against $schema"
              jsonschema -i "$f" "$schema"
            done
          else
            echo "No sample events found to validate."
          fi

      - name: Register schemas to Confluent
        if: github.ref == 'refs/heads/main'
        run: |
          if ls docs/events/schema-registry/*.json 1> /dev/null 2>&1; then
            for f in docs/events/schema-registry/*.json; do
              subject=$(basename $f .json)
              echo "Registering $subject"
              curl -X POST \
                -H "Content-Type: application/json" \
                --data @"$f" \
                $SCHEMA_REGISTRY_URL/subjects/$subject/versions \
                -u "$SCHEMA_REGISTRY_KEY:$SCHEMA_REGISTRY_SECRET"
            done
          else
            echo "No schemas found to register."
          fi
